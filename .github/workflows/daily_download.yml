name: Daily Data Release

permissions:
  contents: write

on:
  schedule:
    - cron: "0 2 * * *" # 0200Z
  workflow_dispatch: # manual trigger if needed

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: pip install requests osm2geojson

      - name: Prepare download folder
        run: mkdir -p downloads

      - name: Download OSM Power Infrastructure
        run: |
          set -e
          echo "âš¡ Running OSM Power ingestor..."
          python3 scripts/osm_power.py

      - name: Publish rolling release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: daily-latest
          name: "Daily Dataset (latest)"
          body: "Automatically updated every day at 02:00 UTC."
          draft: false
          prerelease: false
          files: |
            downloads/osm_power_node_transformer.geojson
            downloads/osm_power_node_switch.geojson
            downloads/osm_power_node_terminal.geojson
            downloads/osm_power_node_converter.geojson
            downloads/osm_power_node_connection.geojson
            downloads/osm_power_node_transition.geojson
            downloads/osm_power_node_compensator.geojson
            downloads/osm_power_node_inverter.geojson
            downloads/osm_power_node_cable_distribution.geojson
            downloads/osm_power_node_cable_distribution_cabinet.geojson
            downloads/osm_power_way_line.geojson
            downloads/osm_power_way_minor_line.geojson
            downloads/osm_power_way_cable.geojson
            downloads/osm_power_way_switchgear.geojson
            downloads/osm_power_way_substation.geojson
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
